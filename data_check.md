# 对所有外部数据进行合法性校验

编程人员处理外部数据过程中必须时刻保持这种思维意识，不要做任何外部数据符合预期的假设。外部数据必须经过严格判断后才能使用

外部数据来源包括但不限于：网络、用户输入、命令行、文件（包括程序配置文件）、环境变量、用户态数据（对于内核程序）、进程间通信（包括管道、消息、共享内存、socket、RPC等）、API参数、全局变量等

典型场景如下：

- 作为数组索引
- 作为内存偏移地址
- 作为内存分配的尺寸参数
- 作为循环条件
- 作为除数
- 作为命令行参数
- 作为数据库查询语句参数
- 作为输入、输出格式化字符串参数
- 作为文件路径

输入校验包括但不限于：

- API接口参数合法性
- 检验数据长度
- 检验数据范围
- 校验数据类型和格式
- 检验输入只包含可接收的字符（'白名单形式'），尤其是需要注意一些特殊字符

> 原则：信任边界、外部数据校验

# 禁止直接使用外部数据拼接sql语句

SQL注入是指外部数据构造的SQL语句所代表的数据库操作与预期不符。这样的操作可能导致信息泄漏或者数据被篡改

防护措施如下：

- 使用参数化查询：最有效的防护手段，但对sql语句中的表名、字段名等不适用
- 对外部数据进行白名单校验：适用于拼接SQL中的表名、字段名
- 对外部数据中SQL注入相关的特殊字符进行转义：使用与拼接sql场景

**反例**

```go
func queryById(id,pwd string){
    // 不符合：直接使用sql拼接
    var sqlStr = "select name from user where id = '"+id+"' and pwd='"+pwd+"'"
}
```

**正例**

```go
func queryById(id,pwd string){
    // 不符合：直接使用sql拼接
    var sqlStr = "select name from user where id = ? and pwd= ?"
    db.Query(sqlStr,id,pwd)
}
```

# 禁止直接使用外部数据拼接命令参数

使用未经检验的不可信输入作为系统命令的参数或命令的一部分，可能会导致命令注入漏洞。

需要注意以下：

- 命令执行的字符串不要取拼接输入的参数。如果必须拼接时，需要对输入参数进行白名单过滤。
- 对传入的参数数据要做类型校验，例如整数数据。
- 保证格式化字符串的正确性。例如int类型的参数拼接要用%d，不要用%s。